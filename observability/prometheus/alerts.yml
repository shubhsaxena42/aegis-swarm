# РЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљ
#  Prometheus Alerting Rules Рђћ Aegis Swarm
# РЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљРЋљ

groups:
  # РћїРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћљ
  # Рћѓ  Drone Fleet Health Alerts                                  Рћѓ
  # РћћРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћў
  - name: drone_fleet_alerts
    rules:
      # РћђРћђ Critical Battery РћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђ
      - alert: DroneBatteryCritical
        expr: aegis_drone_battery_percent < 15
        for: 30s
        labels:
          severity: critical
          team: drone-ops
        annotations:
          summary: "­ЪћІ Drone {{ $labels.drone_id }} battery critically low"
          description: >-
            Drone {{ $labels.drone_id }} battery at {{ $value }}%.
            Immediate RTH (Return-To-Home) required.
          runbook_url: "https://wiki.aegis-swarm/runbooks/battery-critical"

      - alert: DroneBatteryLow
        expr: aegis_drone_battery_percent < 30
        for: 1m
        labels:
          severity: warning
          team: drone-ops
        annotations:
          summary: "­ЪћІ Drone {{ $labels.drone_id }} battery low"
          description: "Drone {{ $labels.drone_id }} battery at {{ $value }}%. Plan RTH."

      # РћђРћђ Connection Loss РћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђ
      - alert: DroneConnectionLost
        expr: aegis_drone_connected == 0
        for: 15s
        labels:
          severity: critical
          team: drone-ops
        annotations:
          summary: "­ЪЊА Drone {{ $labels.drone_id }} connection lost"
          description: >-
            Lost telemetry from drone {{ $labels.drone_id }}.
            Last seen {{ $value }}s ago.

      # РћђРћђ Altitude Breach РћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђ
      - alert: DroneAltitudeExceeded
        expr: aegis_drone_altitude_meters > 120
        for: 10s
        labels:
          severity: warning
          team: drone-ops
        annotations:
          summary: "­ЪЏФ Drone {{ $labels.drone_id }} altitude breach"
          description: "Drone at {{ $value }}m Рђћ exceeds 120m ceiling."

      # РћђРћђ Swarm Health РћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђ
      - alert: SwarmDroneCountLow
        expr: count(aegis_drone_connected == 1) < 3
        for: 1m
        labels:
          severity: warning
          team: drone-ops
        annotations:
          summary: "­ЪљЮ Swarm size critically low"
          description: "Only {{ $value }} drones connected. Minimum swarm size is 3."

      # РћђРћђ Inference Latency РћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђ
      - alert: InferenceLatencyHigh
        expr: aegis_inference_latency_seconds > 0.5
        for: 2m
        labels:
          severity: warning
          team: ml-ops
        annotations:
          summary: "­ЪДа Inference latency too high on drone {{ $labels.drone_id }}"
          description: "Inference latency {{ $value }}s exceeds 500ms threshold."

      # РћђРћђ Motor Anomaly РћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђ
      - alert: DroneMotorAnomaly
        expr: >
          abs(aegis_drone_motor_rpm - avg without(motor_id)(aegis_drone_motor_rpm))
          > 0.3 * avg without(motor_id)(aegis_drone_motor_rpm)
        for: 30s
        labels:
          severity: warning
          team: drone-ops
        annotations:
          summary: "РџЎ№ИЈ Motor anomaly detected on drone {{ $labels.drone_id }}"
          description: "Motor {{ $labels.motor_id }} RPM deviates >30% from mean."

  # РћїРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћљ
  # Рћѓ  Infrastructure Alerts                                      Рћѓ
  # РћћРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћў
  - name: infrastructure_alerts
    rules:
      - alert: RedpandaConsumerLag
        expr: redpanda_kafka_consumer_group_committed_offset - redpanda_kafka_max_offset > 10000
        for: 5m
        labels:
          severity: warning
          team: platform
        annotations:
          summary: "­ЪЊе Redpanda consumer lag high"
          description: "Consumer group {{ $labels.group }} lag is {{ $value }} messages."

      - alert: FlinkJobFailed
        expr: flink_jobmanager_job_numRestarts > 2
        for: 1m
        labels:
          severity: critical
          team: platform
        annotations:
          summary: "­ЪњЦ Flink job restarting repeatedly"
          description: "Job {{ $labels.job_name }} has restarted {{ $value }} times."

      - alert: FlinkCheckpointFailed
        expr: increase(flink_jobmanager_job_lastCheckpointFailed[5m]) > 0
        for: 0s
        labels:
          severity: warning
          team: platform
        annotations:
          summary: "Рџа№ИЈ Flink checkpoint failed"
          description: "Checkpoint failure detected for job {{ $labels.job_name }}."

      - alert: MinIODiskUsageHigh
        expr: minio_disk_storage_used_bytes / minio_disk_storage_total_bytes > 0.85
        for: 5m
        labels:
          severity: warning
          team: platform
        annotations:
          summary: "­ЪњЙ MinIO disk usage above 85%"
          description: "Storage usage at {{ $value | humanizePercentage }}."
