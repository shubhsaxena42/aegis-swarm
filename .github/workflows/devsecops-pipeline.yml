# ══════════════════════════════════════════════════════════════════════════════
#  AEGIS SWARM — DevSecOps CI/CD Pipeline
#  Tools: Gitleaks · Bandit · tfsec · Checkov · OWASP DC · SonarQube
#         Trivy · OWASP ZAP · Falco
# ══════════════════════════════════════════════════════════════════════════════
#
#  Severity Filters:
#    OWASP DC    → Critical + High  (CVSS >= 7)
#    Trivy       → Critical + High
#    SonarQube   → Blocker + Critical
#    ZAP         → High risk only   (riskLevel=3)
#    Falco       → Emergency + Alert + Critical + Error
#
#  Outputs:
#    SBOM (CycloneDX) · SARIF to GitHub Security · Falco audit log
# ──────────────────────────────────────────────────────────────────────────────

name: "Aegis Swarm — DevSecOps Pipeline"

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      run_zap_scan:
        description: "Run OWASP ZAP DAST scan"
        required: false
        default: false
        type: boolean

permissions:
  contents: read
  security-events: write
  actions: read

env:
  PYTHON_VERSION: "3.11"
  IMAGE_TAG: "aegis-swarm:${{ github.sha }}"
  TRIVY_SEVERITY: "CRITICAL,HIGH"

# ═══════════════════════════════════════════════════════════════════════════════
jobs:
  # ┌─────────────────────────────────────────────────────────────────┐
  # │  STAGE 1 — Parallel Static Analysis  (matrix: 3x speed)       │
  # │  Gitleaks + Bandit + IaC scans run simultaneously              │
  # └─────────────────────────────────────────────────────────────────┘
  static-analysis:
    name: "1 · SAST (${{ matrix.scan }})"
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        scan: [gitleaks, bandit, iac]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ── Gitleaks: Secret Scanning ──
      - name: Gitleaks Scan
        if: matrix.scan == 'gitleaks'
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ── Bandit: Python SAST (Medium+) ──
      - name: Bandit Scan
        if: matrix.scan == 'bandit'
        run: |
          pip install bandit -q
          bandit -r . -f sarif -o bandit.sarif --severity-level medium || true

      - name: Upload Bandit SARIF
        if: matrix.scan == 'bandit' && always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: bandit.sarif
          category: bandit

      # ── IaC: tfsec + Checkov ──
      - name: tfsec Scan
        if: matrix.scan == 'iac'
        uses: aquasecurity/tfsec-sarif-action@v0.1.4
        with:
          working_directory: .
          sarif_file: tfsec.sarif
        continue-on-error: true

      - name: Checkov Scan
        if: matrix.scan == 'iac'
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: .
          framework: terraform
          output_format: sarif
          output_file_path: checkov.sarif
          soft_fail: true

      - name: Upload tfsec SARIF
        if: matrix.scan == 'iac' && always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: tfsec.sarif
          category: tfsec
        continue-on-error: true

      - name: Upload Checkov SARIF
        if: matrix.scan == 'iac' && always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: checkov.sarif
          category: checkov
        continue-on-error: true

  # ┌─────────────────────────────────────────────────────────────────┐
  # │  STAGE 2 — Dependency & Quality  (OWASP DC + SonarQube)       │
  # │  OWASP DC: CVSS >= 7   ·   SonarQube: Blocker + Critical      │
  # └─────────────────────────────────────────────────────────────────┘
  dependency-quality:
    name: "2 · SCA & SonarQube"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      # ── OWASP Dependency-Check (CVSS >= 7) ──
      - name: OWASP Dependency-Check
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: "aegis-swarm"
          path: "."
          format: "JSON,SARIF"
          args: >-
            --failOnCVSS 7
            --enableExperimental

      - name: Upload OWASP DC SARIF
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: reports/dependency-check-report.sarif
          category: owasp-dc

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: owasp-dc-report
          path: reports/

      # ── SonarQube (Blocker + Critical) ──
      - name: Generate Coverage
        run: |
          pip install pytest pytest-cov -q
          pip install -r requirements.txt 2>/dev/null || true
          pytest --cov=. --cov-report=xml 2>/dev/null || true

      - name: SonarQube Scan
        uses: SonarSource/sonarqube-scan-action@v4
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        with:
          args: >-
            -Dsonar.qualitygate.wait=true
            -Dsonar.qualitygate.timeout=300
            -Dsonar.issue.severity=BLOCKER,CRITICAL

      - name: SonarQube Quality Gate
        uses: sonarsource/sonarqube-quality-gate-action@v1
        timeout-minutes: 5
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  # ┌─────────────────────────────────────────────────────────────────┐
  # │  STAGE 3 — Container Scan + SBOM  (Trivy: Critical + High)    │
  # └─────────────────────────────────────────────────────────────────┘
  container-security:
    name: "3 · Trivy + SBOM"
    runs-on: ubuntu-latest
    needs: [static-analysis]
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3

      - name: Build Image
        run: |
          if [ -f Dockerfile ]; then
            docker build -t ${{ env.IMAGE_TAG }} .
          else
            echo "No Dockerfile — skipping image build"
          fi

      # ── Filesystem Scan (Critical + High) ──
      - name: Trivy FS Scan
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: "fs"
          format: "sarif"
          output: "trivy-fs.sarif"
          severity: ${{ env.TRIVY_SEVERITY }}
          exit-code: "0"

      # ── Image Scan (Critical + High, fail on findings) ──
      - name: Trivy Image Scan
        if: hashFiles('Dockerfile') != ''
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ${{ env.IMAGE_TAG }}
          format: "sarif"
          output: "trivy-image.sarif"
          severity: ${{ env.TRIVY_SEVERITY }}
          exit-code: "1"
          ignore-unfixed: true
        continue-on-error: true

      # ── SBOM Generation (CycloneDX) ──
      - name: Generate SBOM
        if: hashFiles('Dockerfile') != ''
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ${{ env.IMAGE_TAG }}
          format: "cyclonedx"
          output: "sbom.cyclonedx.json"

      # ── Upload ──
      - name: Upload FS SARIF
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: trivy-fs.sarif
          category: trivy-fs

      - name: Upload Image SARIF
        uses: github/codeql-action/upload-sarif@v3
        if: always() && hashFiles('Dockerfile') != ''
        with:
          sarif_file: trivy-image.sarif
          category: trivy-image
        continue-on-error: true

      - name: Upload SBOM
        uses: actions/upload-artifact@v4
        with:
          name: software-bill-of-materials
          path: sbom.cyclonedx.json
        continue-on-error: true

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: trivy-reports
          path: trivy-*.sarif

  # ┌─────────────────────────────────────────────────────────────────┐
  # │  STAGE 4 — DAST + Runtime  (ZAP + Falco, parallel)            │
  # │  ZAP: High risk   ·   Falco: Emergency/Alert/Critical/Error   │
  # └─────────────────────────────────────────────────────────────────┘

  # ── 4a: ZAP DAST ──
  zap-dast:
    name: "4a · ZAP DAST (High)"
    runs-on: ubuntu-latest
    needs: [container-security]
    if: >-
      github.ref == 'refs/heads/main' ||
      inputs.run_zap_scan == true
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Start App
        run: |
          pip install flask gunicorn -q
          pip install -r requirements.txt 2>/dev/null || true
          if [ -f app.py ]; then
            python app.py &
            for i in $(seq 1 15); do
              curl -s http://localhost:8080/ > /dev/null 2>&1 && break
              sleep 1
            done
          fi

      - name: ZAP Baseline (High only)
        uses: zaproxy/action-baseline@v0.14.0
        with:
          target: "http://localhost:8080/"
          rules_file_name: ".github/zap-rules.tsv"
          cmd_options: '-a -j -z "-config view.alertFilter.riskLevel=3"'
          fail_action: false
          artifact_name: "zap-report"

  # ── 4b: Falco Runtime ──
  falco-runtime:
    name: "4b · Falco Runtime"
    runs-on: ubuntu-latest
    needs: [container-security]
    steps:
      - uses: actions/checkout@v4

      - name: Install Falco
        run: |
          curl -fsSL https://falco.org/repo/falcosecurity-packages.asc | \
            sudo gpg --dearmor -o /usr/share/keyrings/falco-archive-keyring.gpg
          echo "deb [signed-by=/usr/share/keyrings/falco-archive-keyring.gpg] \
            https://download.falco.org/packages/deb stable main" | \
            sudo tee /etc/apt/sources.list.d/falcosecurity.list
          sudo apt-get update -y
          sudo FALCO_FRONTEND=noninteractive apt-get install -y falco
          falco --version

      - name: Write Custom Rules
        run: |
          cat > /tmp/aegis-rules.yaml << 'EOF'
          - rule: Sensitive File Access
            desc: Detect access to secrets, keys, or credential files
            condition: >
              open_read and container and
              (fd.name startswith /etc/shadow or
               fd.name contains "private_key" or
               fd.name contains ".pem" or
               fd.name contains ".env")
            output: "Sensitive file access (file=%fd.name cmd=%proc.cmdline container=%container.name)"
            priority: CRITICAL
            tags: [filesystem, aegis-swarm]

          - rule: Privilege Escalation
            desc: Detect setuid/setgid syscalls in containers
            condition: evt.type in (setuid, setgid) and container and evt.dir=>
            output: "Privilege escalation (cmd=%proc.cmdline container=%container.name)"
            priority: CRITICAL
            tags: [privilege, aegis-swarm]

          - rule: Package Manager in Container
            desc: Detect package manager usage in running containers
            condition: >
              spawned_process and container and
              proc.name in (apt, apt-get, yum, dnf, apk, pip, pip3, npm)
            output: "Package manager executed (cmd=%proc.cmdline container=%container.name)"
            priority: ERROR
            tags: [software_mgmt, aegis-swarm]

          - rule: Shell Spawned in Container
            desc: Detect interactive shells in containers
            condition: >
              spawned_process and container and
              proc.name in (bash, sh, dash, zsh)
            output: "Shell spawned (cmd=%proc.cmdline container=%container.name)"
            priority: ERROR
            tags: [process, aegis-swarm]

          - rule: Outbound to Non-RFC1918
            desc: Unexpected egress traffic from container
            condition: >
              outbound and container and
              not (fd.sip in (rfc_1918_addresses))
            output: "Unexpected outbound connection (connection=%fd.name container=%container.name)"
            priority: ALERT
            tags: [network, aegis-swarm]
          EOF

      - name: Run Falco Audit
        run: |
          # Build & start container for runtime audit
          docker build -t ${{ env.IMAGE_TAG }} . 2>/dev/null && \
            docker run -d --name aegis-audit ${{ env.IMAGE_TAG }} sleep 30 2>/dev/null || true

          # priority=error captures: Emergency, Alert, Critical, Error
          sudo falco \
            -r /etc/falco/falco_rules.yaml \
            -r /tmp/aegis-rules.yaml \
            -o "json_output=true" \
            -o "priority=error" \
            -M 20 2>/dev/null | tee /tmp/falco-output.json || true

          # Validate custom rules
          sudo falco --validate /tmp/aegis-rules.yaml 2>/dev/null || true

          # Count by severity
          EMERG=$(grep -c '"priority":"Emergency"' /tmp/falco-output.json 2>/dev/null || echo "0")
          ALERT=$(grep -c '"priority":"Alert"' /tmp/falco-output.json 2>/dev/null || echo "0")
          CRIT=$(grep -c '"priority":"Critical"' /tmp/falco-output.json 2>/dev/null || echo "0")
          ERR=$(grep -c '"priority":"Error"' /tmp/falco-output.json 2>/dev/null || echo "0")
          echo "Falco findings: $EMERG emergency, $ALERT alert, $CRIT critical, $ERR error"

          # Fail on Emergency or Alert
          if [ "$EMERG" -gt 0 ] || [ "$ALERT" -gt 0 ]; then
            echo "High-severity Falco events detected"
            exit 1
          fi

          # Cleanup
          docker stop aegis-audit 2>/dev/null || true
          docker rm aegis-audit 2>/dev/null || true
        continue-on-error: true

      - name: Upload Falco Log
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: falco-audit-log
          path: /tmp/falco-output.json

  # ┌─────────────────────────────────────────────────────────────────┐
  # │  STAGE 5 — Consolidated Security Report                        │
  # └─────────────────────────────────────────────────────────────────┘
  security-report:
    name: "5 · Security Report"
    runs-on: ubuntu-latest
    if: always()
    needs:
      - static-analysis
      - dependency-quality
      - container-security
      - zap-dast
      - falco-runtime
    steps:
      - uses: actions/download-artifact@v4
        with:
          merge-multiple: true
          path: reports/
        continue-on-error: true

      - name: Generate Summary
        run: |
          S="${GITHUB_STEP_SUMMARY}"

          echo "# Aegis Swarm - Security Report" >> "$S"
          echo "" >> "$S"
          echo "Run \`${{ github.run_id }}\` on \`${{ github.ref_name }}\` @ \`${{ github.sha }}\`" >> "$S"
          echo "" >> "$S"

          echo "## Severity Filters" >> "$S"
          echo "" >> "$S"
          echo "| Tool | Filter |" >> "$S"
          echo "|------|--------|" >> "$S"
          echo "| Gitleaks | All secrets |" >> "$S"
          echo "| Bandit | Medium+ |" >> "$S"
          echo "| OWASP DC | CVSS >= 7 (Critical + High) |" >> "$S"
          echo "| SonarQube | Blocker + Critical |" >> "$S"
          echo "| Trivy | Critical + High |" >> "$S"
          echo "| ZAP | High risk (riskLevel 3+) |" >> "$S"
          echo "| Falco | Emergency + Alert + Critical + Error |" >> "$S"
          echo "" >> "$S"

          echo "## Results" >> "$S"
          echo "" >> "$S"
          echo "| Stage | Tool | Status |" >> "$S"
          echo "|-------|------|--------|" >> "$S"
          echo "| 1 | SAST (Gitleaks/Bandit/IaC) | ${{ needs.static-analysis.result }} |" >> "$S"
          echo "| 2 | OWASP DC + SonarQube | ${{ needs.dependency-quality.result }} |" >> "$S"
          echo "| 3 | Trivy + SBOM | ${{ needs.container-security.result }} |" >> "$S"
          echo "| 4a | ZAP DAST | ${{ needs.zap-dast.result }} |" >> "$S"
          echo "| 4b | Falco Runtime | ${{ needs.falco-runtime.result }} |" >> "$S"
          echo "" >> "$S"

          echo "## SBOM" >> "$S"
          if [ -f reports/sbom.cyclonedx.json ]; then
            echo "CycloneDX SBOM generated - see artifacts" >> "$S"
          else
            echo "No SBOM generated (no Dockerfile)" >> "$S"
          fi
          echo "" >> "$S"

          echo "## Artifacts" >> "$S"
          if [ -d reports ]; then
            find reports -type f | sort | while read f; do
              echo "- \`$f\`" >> "$S"
            done
          fi

      - uses: actions/upload-artifact@v4
        with:
          name: consolidated-security-reports
          path: reports/
          retention-days: 30

      - name: Fail on Secrets
        if: needs.static-analysis.result == 'failure'
        run: exit 1
